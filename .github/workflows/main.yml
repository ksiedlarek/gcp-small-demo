on:
  push:
    branches:
      - main

env:
  PROJECT_ID: 'tf-demo-375508'
  SA: 'gitlab-tf-demo@tf-demo-375508.iam.gserviceaccount.com'
  WORKLOAD_IDENTITY_PROVIDER: 'projects/696181559141/locations/global/workloadIdentityPools/github/providers/github'
jobs:
  initialize:
    name: Initialize
    runs-on: ubuntu-latest
    # Add "id-token" with the intended permissions.
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Install Terraform
      uses: hashicorp/setup-terraform@v2

    - name: Auth to GCP
      id: 'auth'
      uses: 'google-github-actions/auth@v1'
      with:
        workload_identity_provider: '${{ env.WORKLOAD_IDENTITY_PROVIDER }}'
        service_account: '${{ env.SA }}'

    - name: Set up Cloud SDK
      uses: 'google-github-actions/setup-gcloud@v1'

    - name: Test command - gcloud info
      run: 'gcloud info'

    - name: Terraform init
      run: |
        terraform init

    - name: Terraform validate
      run: |
        terraform validate

    - name: Terraform plan
      run: |
        terraform plan

  apply:
    name: Terraform Apply
    runs-on: ubuntu-latest
    needs: initialize
    permissions:
      contents: 'read'
      id-token: 'write'
    environment:
        name: dev
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Install Terraform
        uses: hashicorp/setup-terraform@v2

      - name: Auth to GCP
        id: 'auth'
        uses: 'google-github-actions/auth@v1'
        with:
          workload_identity_provider: '${{ env.WORKLOAD_IDENTITY_PROVIDER }}'
          service_account: '${{ env.SA }}'

      - name: Set up Cloud SDK
        uses: 'google-github-actions/setup-gcloud@v1'

      - name: Terraform init
        run: |
          terraform init

      - name: Terraform apply
        run: |
          terraform apply -auto-approve
